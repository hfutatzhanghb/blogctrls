<!DOCTYPE html>
<!-- saved from url=(0052)https://javadoop.com/post/AbstractQueuedSynchronizer -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>一行一行源码分析清楚AbstractQueuedSynchronizer</title>

    <link rel="icon" href="https://javadoop.com/images/favor.ico">

    <link href="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/highlight.min.css">
    <link rel="stylesheet" type="text/css" href="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/2051.css">

    <script src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/jquery.min.js"></script>
    <script src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/jquery.cookie.js"></script>
    <script src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/vue.min.js"></script>
    <script src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/bootstrap.min.js"></script>
    <script src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/highlight.min.js"></script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body class="yellow" style="">
<div>
    <div id="wrapper">
        <nav class="hidden-xs" id="toc" data-toggle="toc" style="display: none;"><ul class="nav"><li><a href="https://javadoop.com/post/AbstractQueuedSynchronizer#toc0">AQS 结构</a></li><li><a href="https://javadoop.com/post/AbstractQueuedSynchronizer#toc1">线程抢锁</a></li><li><a href="https://javadoop.com/post/AbstractQueuedSynchronizer#toc2">解锁操作</a></li><li><a href="https://javadoop.com/post/AbstractQueuedSynchronizer#toc3">总结</a></li><li><a href="https://javadoop.com/post/AbstractQueuedSynchronizer#toc4">示例图解析</a></li></ul></nav>
        
        <div id="content">

            
            <a id="back-to-home" href="https://javadoop.com/">
                <i class="glyphicon glyphicon-home"></i> 回首页
            </a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;新的主题，右下角可以设置，欢迎大家提出建议。
            <div class="title">一行一行源码分析清楚AbstractQueuedSynchronizer</div>
            <div class="updateTime">更新时间：2017-06-16</div>
            <p>在分析 Java 并发包 java.util.concurrent 源码的时候，少不了需要了解 AbstractQueuedSynchronizer（以下简写AQS）这个抽象类，因为它是 Java 并发包的基础工具类，是实现 ReentrantLock、CountDownLatch、Semaphore、FutureTask 等类的基础。</p>
<p>Google 一下 AbstractQueuedSynchronizer，我们可以找到很多关于 AQS 的介绍，但是很多都没有介绍清楚，因为大部分文章没有把其中的一些关键的细节说清楚。</p>
<p>本文将从 ReentrantLock 的公平锁源码出发，分析下 AbstractQueuedSynchronizer 这个类是怎么工作的，希望能给大家提供一些简单的帮助。</p>
<!--more-->
<p>申明以下几点：</p>
<ol>
<li>本文有点长，但是很简单很简单很简单，主要面向读者对象为并发编程的初学者，或者想要阅读java并发包源码的开发者。</li>
<li>建议在电脑上阅读，如果你想好好地理解所有的细节，而且你从来没看过相关的分析，你可能至少需要 20 分钟仔细看所有的描述，本文后面的 1/3 以上很简单，前面的 1/4 更简单，中间的部分要好好看。</li>
<li>如果你不知道为什么要看这个，我想告诉你，即使你看懂了所有的细节，你可能也不能把你的业务代码写得更好</li>
<li>源码环境 JDK1.7，看到不懂或有疑惑的部分，最好能自己打开源码看看。Doug Lea 大神的代码写得真心不错。</li>
<li>有很多英文注释我没有删除，这样读者可以参考着英文说的来，万一被我忽悠了呢</li>
<li>本文不分析共享模式，这样可以给读者减少很多负担，只要把独占模式看懂，共享模式读者应该就可以顺着代码看懂了。而且也不分析 condition 部分，所以应该说很容易就可以看懂了。</li>
<li>本文大量使用我们平时用得最多的 ReentrantLock 的概念，本质上来说是不正确的，读者应该清楚，AQS 不仅仅用来实现锁，只是希望读者可以用锁来联想 AQS 的使用场景，降低读者的阅读压力</li>
<li>ReentrantLock 的公平锁和非公平锁只有一点点区别，没有任何阅读压力</li>
<li>你需要提前知道什么是 CAS(CompareAndSet)</li>
</ol>
<p>废话结束，开始。</p>
<span id="toc0"></span><h2 id="AQS%20%E7%BB%93%E6%9E%84">AQS 结构</h2>
<p>先来看看 AQS 有哪些属性，搞清楚这些基本就知道 AQS 是什么套路了，毕竟可以猜嘛！</p>
<pre><code class="lang-java hljs"><span class="hljs-comment"><span class="hljs-comment">// 头结点，你直接把它当做 当前持有锁的线程 可能是最好理解的</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">transient</span></span> <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> Node head;
<span class="hljs-comment"><span class="hljs-comment">// 阻塞的尾节点，每个新的节点进来，都插入到最后，也就形成了一个隐视的链表</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">transient</span></span> <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> Node tail;
<span class="hljs-comment"><span class="hljs-comment">// 这个是最重要的，不过也是最简单的，代表当前锁的状态，0代表没有被占用，大于0代表有线程持有当前锁</span></span>
<span class="hljs-comment"><span class="hljs-comment">// 之所以说大于0，而不是等于1，是因为锁可以重入嘛，每次重入都加上1</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> state;
<span class="hljs-comment"><span class="hljs-comment">// 代表当前持有独占锁的线程，举个最重要的使用例子，因为锁可以重入</span></span>
<span class="hljs-comment"><span class="hljs-comment">// reentrantLock.lock()可以嵌套调用多次，所以每次用这个来判断当前线程是否已经拥有了锁</span></span>
<span class="hljs-comment"><span class="hljs-comment">// if (currentThread == getExclusiveOwnerThread()) {state++}</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">transient</span></span> Thread exclusiveOwnerThread; <span class="hljs-comment"><span class="hljs-comment">//继承自AbstractOwnableSynchronizer</span></span>
</code></pre>
<p>怎么样，看样子应该是很简单的吧，毕竟也就四个属性啊。</p>
<p>AbstractQueuedSynchronizer 的等待队列示意如下所示，注意了，之后分析过程中所说的 queue，也就是阻塞队列不包含 head，不包含 head，不包含 head。</p>
<p><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/aqs-0.png" alt="aqs-0"></p>
<p>等待队列中每个线程被包装成一个 node，数据结构是链表，一起看看源码吧：</p>
<pre><code class="lang-java hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Node</span></span></span><span class="hljs-class"> </span></span>{
    <span class="hljs-comment"><span class="hljs-comment">/** Marker to indicate a node is waiting in shared mode */</span></span>
    <span class="hljs-comment"><span class="hljs-comment">// 标识节点当前在共享模式下</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Node SHARED = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Node();
    <span class="hljs-comment"><span class="hljs-comment">/** Marker to indicate a node is waiting in exclusive mode */</span></span>
    <span class="hljs-comment"><span class="hljs-comment">// 标识节点当前在独占模式下</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Node EXCLUSIVE = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>;

    <span class="hljs-comment"><span class="hljs-comment">// ======== 下面的几个int常量是给waitStatus用的 ===========</span></span>
    <span class="hljs-comment"><span class="hljs-comment">/** waitStatus value to indicate thread has cancelled */</span></span>
    <span class="hljs-comment"><span class="hljs-comment">// 代码此线程取消了争抢这个锁</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> CANCELLED =  <span class="hljs-number"><span class="hljs-number">1</span></span>;
    <span class="hljs-comment"><span class="hljs-comment">/** waitStatus value to indicate successor's thread needs unparking */</span></span>
    <span class="hljs-comment"><span class="hljs-comment">// 官方的描述是，其表示当前node的后继节点对应的线程需要被唤醒</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> SIGNAL    = -<span class="hljs-number"><span class="hljs-number">1</span></span>;
    <span class="hljs-comment"><span class="hljs-comment">/** waitStatus value to indicate thread is waiting on condition */</span></span>
    <span class="hljs-comment"><span class="hljs-comment">// 本文不分析condition，所以略过吧，下一篇文章会介绍这个</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> CONDITION = -<span class="hljs-number"><span class="hljs-number">2</span></span>;
    <span class="hljs-comment"><span class="hljs-comment">/**
     * waitStatus value to indicate the next acquireShared should
     * unconditionally propagate
     */</span></span>
    <span class="hljs-comment"><span class="hljs-comment">// 同样的不分析，略过吧</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> PROPAGATE = -<span class="hljs-number"><span class="hljs-number">3</span></span>;
    <span class="hljs-comment"><span class="hljs-comment">// =====================================================</span></span>

    <span class="hljs-comment"><span class="hljs-comment">// 取值为上面的1、-1、-2、-3，或者0(以后会讲到)</span></span>
    <span class="hljs-comment"><span class="hljs-comment">// 这么理解，暂时只需要知道如果这个值 大于0 代表此线程取消了等待，</span></span>
    <span class="hljs-comment"><span class="hljs-comment">// 也许就是说半天抢不到锁，不抢了，ReentrantLock是可以指定timeouot的。。。</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> waitStatus;
    <span class="hljs-comment"><span class="hljs-comment">// 前驱节点的引用</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> Node prev;
    <span class="hljs-comment"><span class="hljs-comment">// 后继节点的引用</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> Node next;
    <span class="hljs-comment"><span class="hljs-comment">// 这个就是线程本尊</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> Thread thread;

}
</code></pre>
<p>Node 的数据结构其实也挺简单的，就是 thread + waitStatus + pre + next 四个属性而已，大家先要有这个概念在心里。</p>
<p>上面的是基础知识，后面会多次用到，心里要时刻记着它们，心里想着这个结构图就可以了。下面，我们开始说 ReentrantLock 的公平锁。多嘴一下，我说的阻塞队列不包含 head 节点。</p>
<p><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/aqs-0.png" alt="aqs-0"></p>
<p>首先，我们先看下 ReentrantLock 的使用方式。</p>
<pre><code class="lang-java hljs"><span class="hljs-comment"><span class="hljs-comment">// 我用个web开发中的service概念吧</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OrderService</span></span></span><span class="hljs-class"> </span></span>{
    <span class="hljs-comment"><span class="hljs-comment">// 使用static，这样每个线程拿到的是同一把锁，当然，spring mvc中service默认就是单例，别纠结这个</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> ReentrantLock reentrantLock = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReentrantLock(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>);

    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createOrder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{
        <span class="hljs-comment"><span class="hljs-comment">// 比如我们同一时间，只允许一个线程创建订单</span></span>
        reentrantLock.lock();
        <span class="hljs-comment"><span class="hljs-comment">// 通常，lock 之后紧跟着 try 语句</span></span>
        <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> {
            <span class="hljs-comment"><span class="hljs-comment">// 这块代码同一时间只能有一个线程进来(获取到锁的线程)，</span></span>
            <span class="hljs-comment"><span class="hljs-comment">// 其他的线程在lock()方法上阻塞，等待获取到锁，再进来</span></span>
            <span class="hljs-comment"><span class="hljs-comment">// 执行代码...</span></span>
            <span class="hljs-comment"><span class="hljs-comment">// 执行代码...</span></span>
            <span class="hljs-comment"><span class="hljs-comment">// 执行代码...</span></span>
        } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> {
            <span class="hljs-comment"><span class="hljs-comment">// 释放锁</span></span>
            reentrantLock.unlock();
        }
    }
}
</code></pre>
<p>ReentrantLock 在内部用了内部类 Sync 来管理锁，所以真正的获取锁和释放锁是由 Sync 的实现类来控制的。</p>
<pre><code class="lang-java hljs"><span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Sync</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractQueuedSynchronizer</span></span></span><span class="hljs-class"> </span></span>{

}
</code></pre>
<p>Sync 有两个实现，分别为 NonfairSync（非公平锁）和 FairSync（公平锁），我们看 FairSync 部分。</p>
<pre><code class="lang-java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReentrantLock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fair)</span></span></span><span class="hljs-function"> </span></span>{
    sync = fair ? <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FairSync() : <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NonfairSync();
}
</code></pre>
<span id="toc1"></span><h2 id="%E7%BA%BF%E7%A8%8B%E6%8A%A2%E9%94%81">线程抢锁</h2>
<p>很多人肯定开始嫌弃上面废话太多了，下面跟着代码走，我就不废话了。</p>
<pre><code class="lang-java hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FairSync</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Sync</span></span></span><span class="hljs-class"> </span></span>{
    <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> serialVersionUID = -<span class="hljs-number"><span class="hljs-number">3000897897090466540L</span></span>;
      <span class="hljs-comment"><span class="hljs-comment">// 争锁</span></span>
    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{
        acquire(<span class="hljs-number"><span class="hljs-number">1</span></span>);
    }
      <span class="hljs-comment"><span class="hljs-comment">// 来自父类AQS，我直接贴过来这边，下面分析的时候同样会这样做，不会给读者带来阅读压力</span></span>
    <span class="hljs-comment"><span class="hljs-comment">// 我们看到，这个方法，如果tryAcquire(arg) 返回true, 也就结束了。</span></span>
    <span class="hljs-comment"><span class="hljs-comment">// 否则，acquireQueued方法会将线程压到队列中</span></span>
    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">acquire</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> arg)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// 此时 arg == 1</span></span>
        <span class="hljs-comment"><span class="hljs-comment">// 首先调用tryAcquire(1)一下，名字上就知道，这个只是试一试</span></span>
        <span class="hljs-comment"><span class="hljs-comment">// 因为有可能直接就成功了呢，也就不需要进队列排队了，</span></span>
        <span class="hljs-comment"><span class="hljs-comment">// 对于公平锁的语义就是：本来就没人持有锁，根本没必要进队列等待(又是挂起，又是等待被唤醒的)</span></span>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!tryAcquire(arg) &amp;&amp;
            <span class="hljs-comment"><span class="hljs-comment">// tryAcquire(arg)没有成功，这个时候需要把当前线程挂起，放到阻塞队列中。</span></span>
            acquireQueued(addWaiter(Node.EXCLUSIVE), arg)) {
              selfInterrupt();
        }
    }

    <span class="hljs-comment"><span class="hljs-comment">/**
     * Fair version of tryAcquire.  Don't grant access unless
     * recursive call or no waiters or is first.
     */</span></span>
    <span class="hljs-comment"><span class="hljs-comment">// 尝试直接获取锁，返回值是boolean，代表是否获取到锁</span></span>
    <span class="hljs-comment"><span class="hljs-comment">// 返回true：1.没有线程在等待锁；2.重入锁，线程本来就持有锁，也就可以理所当然可以直接获取</span></span>
    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tryAcquire</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> acquires)</span></span></span><span class="hljs-function"> </span></span>{
        <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Thread current = Thread.currentThread();
        <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> c = getState();
        <span class="hljs-comment"><span class="hljs-comment">// state == 0 此时此刻没有线程持有锁</span></span>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c == <span class="hljs-number"><span class="hljs-number">0</span></span>) {
            <span class="hljs-comment"><span class="hljs-comment">// 虽然此时此刻锁是可以用的，但是这是公平锁，既然是公平，就得讲究先来后到，</span></span>
            <span class="hljs-comment"><span class="hljs-comment">// 看看有没有别人在队列中等了半天了</span></span>
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!hasQueuedPredecessors() &amp;&amp;
                <span class="hljs-comment"><span class="hljs-comment">// 如果没有线程在等待，那就用CAS尝试一下，成功了就获取到锁了，</span></span>
                <span class="hljs-comment"><span class="hljs-comment">// 不成功的话，只能说明一个问题，就在刚刚几乎同一时刻有个线程抢先了 =_=</span></span>
                <span class="hljs-comment"><span class="hljs-comment">// 因为刚刚还没人的，我判断过了???</span></span>
                compareAndSetState(<span class="hljs-number"><span class="hljs-number">0</span></span>, acquires)) {

                <span class="hljs-comment"><span class="hljs-comment">// 到这里就是获取到锁了，标记一下，告诉大家，现在是我占用了锁</span></span>
                setExclusiveOwnerThread(current);
                <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>;
            }
        }
          <span class="hljs-comment"><span class="hljs-comment">// 会进入这个else if分支，说明是重入了，需要操作：state=state+1</span></span>
        <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (current == getExclusiveOwnerThread()) {
            <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nextc = c + acquires;
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (nextc &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>)
                <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Error(<span class="hljs-string"><span class="hljs-string">"Maximum lock count exceeded"</span></span>);
            setState(nextc);
            <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>;
        }
        <span class="hljs-comment"><span class="hljs-comment">// 如果到这里，说明前面的if和else if都没有返回true，说明没有获取到锁</span></span>
        <span class="hljs-comment"><span class="hljs-comment">// 回到上面一个外层调用方法继续看:</span></span>
        <span class="hljs-comment"><span class="hljs-comment">// if (!tryAcquire(arg) </span></span>
        <span class="hljs-comment"><span class="hljs-comment">//        &amp;&amp; acquireQueued(addWaiter(Node.EXCLUSIVE), arg)) </span></span>
        <span class="hljs-comment"><span class="hljs-comment">//     selfInterrupt();</span></span>
        <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>;
    }

    <span class="hljs-comment"><span class="hljs-comment">// 假设tryAcquire(arg) 返回false，那么代码将执行：</span></span>
      <span class="hljs-comment"><span class="hljs-comment">//        acquireQueued(addWaiter(Node.EXCLUSIVE), arg)，</span></span>
    <span class="hljs-comment"><span class="hljs-comment">// 这个方法，首先需要执行：addWaiter(Node.EXCLUSIVE)</span></span>

    <span class="hljs-comment"><span class="hljs-comment">/**
     * Creates and enqueues node for current thread and given mode.
     *
     * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> mode Node.EXCLUSIVE for exclusive, Node.SHARED for shared
     * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> the new node
     */</span></span>
    <span class="hljs-comment"><span class="hljs-comment">// 此方法的作用是把线程包装成node，同时进入到队列中</span></span>
    <span class="hljs-comment"><span class="hljs-comment">// 参数mode此时是Node.EXCLUSIVE，代表独占模式</span></span>
    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Node </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addWaiter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Node mode)</span></span></span><span class="hljs-function"> </span></span>{
        Node node = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Node(Thread.currentThread(), mode);
        <span class="hljs-comment"><span class="hljs-comment">// Try the fast path of enq; backup to full enq on failure</span></span>
        <span class="hljs-comment"><span class="hljs-comment">// 以下几行代码想把当前node加到链表的最后面去，也就是进到阻塞队列的最后</span></span>
        Node pred = tail;

        <span class="hljs-comment"><span class="hljs-comment">// tail!=null =&gt; 队列不为空(tail==head的时候，其实队列是空的，不过不管这个吧)</span></span>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pred != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { 
            <span class="hljs-comment"><span class="hljs-comment">// 设置自己的前驱 为当前的队尾节点</span></span>
            node.prev = pred; 
            <span class="hljs-comment"><span class="hljs-comment">// 用CAS把自己设置为队尾, 如果成功后，tail == node了</span></span>
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (compareAndSetTail(pred, node)) { 
                <span class="hljs-comment"><span class="hljs-comment">// 进到这里说明设置成功，当前node==tail, 将自己与之前的队尾相连，</span></span>
                <span class="hljs-comment"><span class="hljs-comment">// 上面已经有 node.prev = pred</span></span>
                <span class="hljs-comment"><span class="hljs-comment">// 加上下面这句，也就实现了和之前的尾节点双向连接了</span></span>
                pred.next = node;
                <span class="hljs-comment"><span class="hljs-comment">// 线程入队了，可以返回了</span></span>
                <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> node;
            }
        }
        <span class="hljs-comment"><span class="hljs-comment">// 仔细看看上面的代码，如果会到这里，</span></span>
        <span class="hljs-comment"><span class="hljs-comment">// 说明 pred==null(队列是空的) 或者 CAS失败(有线程在竞争入队)</span></span>
        <span class="hljs-comment"><span class="hljs-comment">// 读者一定要跟上思路，如果没有跟上，建议先不要往下读了，往回仔细看，否则会浪费时间的</span></span>
        enq(node);
        <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> node;
    }

    <span class="hljs-comment"><span class="hljs-comment">/**
     * Inserts node into queue, initializing if necessary. See picture above.
     * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> node the node to insert
     * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> node's predecessor
     */</span></span>
    <span class="hljs-comment"><span class="hljs-comment">// 采用自旋的方式入队</span></span>
    <span class="hljs-comment"><span class="hljs-comment">// 之前说过，到这个方法只有两种可能：等待队列为空，或者有线程竞争入队，</span></span>
    <span class="hljs-comment"><span class="hljs-comment">// 自旋在这边的语义是：CAS设置tail过程中，竞争一次竞争不到，我就多次竞争，总会排到的</span></span>
    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Node </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">enq</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Node node)</span></span></span><span class="hljs-function"> </span></span>{
        <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (;;) {
            Node t = tail;
            <span class="hljs-comment"><span class="hljs-comment">// 之前说过，队列为空也会进来这里</span></span>
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (t == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// Must initialize</span></span>
                <span class="hljs-comment"><span class="hljs-comment">// 初始化head节点</span></span>
                <span class="hljs-comment"><span class="hljs-comment">// 细心的读者会知道原来head和tail初始化的时候都是null，反正我不细心</span></span>
                <span class="hljs-comment"><span class="hljs-comment">// 还是一步CAS，你懂的，现在可能是很多线程同时进来呢</span></span>
                <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (compareAndSetHead(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Node()))
                    <span class="hljs-comment"><span class="hljs-comment">// 给后面用：这个时候head节点的waitStatus==0, 看new Node()构造方法就知道了</span></span>

                    <span class="hljs-comment"><span class="hljs-comment">// 这个时候有了head，但是tail还是null，设置一下，</span></span>
                    <span class="hljs-comment"><span class="hljs-comment">// 把tail指向head，放心，马上就有线程要来了，到时候tail就要被抢了</span></span>
                    <span class="hljs-comment"><span class="hljs-comment">// 注意：这里只是设置了tail=head，这里可没return哦，没有return，没有return</span></span>
                    <span class="hljs-comment"><span class="hljs-comment">// 所以，设置完了以后，继续for循环，下次就到下面的else分支了</span></span>
                    tail = head;
            } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {
                <span class="hljs-comment"><span class="hljs-comment">// 下面几行，和上一个方法 addWaiter 是一样的，</span></span>
                <span class="hljs-comment"><span class="hljs-comment">// 只是这个套在无限循环里，反正就是将当前线程排到队尾，有线程竞争的话排不上重复排</span></span>
                node.prev = t;
                <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (compareAndSetTail(t, node)) {
                    t.next = node;
                    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> t;
                }
            }
        }
    }


    <span class="hljs-comment"><span class="hljs-comment">// 现在，又回到这段代码了</span></span>
    <span class="hljs-comment"><span class="hljs-comment">// if (!tryAcquire(arg) </span></span>
    <span class="hljs-comment"><span class="hljs-comment">//        &amp;&amp; acquireQueued(addWaiter(Node.EXCLUSIVE), arg)) </span></span>
    <span class="hljs-comment"><span class="hljs-comment">//     selfInterrupt();</span></span>

    <span class="hljs-comment"><span class="hljs-comment">// 下面这个方法，参数node，经过addWaiter(Node.EXCLUSIVE)，此时已经进入阻塞队列</span></span>
    <span class="hljs-comment"><span class="hljs-comment">// 注意一下：如果acquireQueued(addWaiter(Node.EXCLUSIVE), arg))返回true的话，</span></span>
    <span class="hljs-comment"><span class="hljs-comment">// 意味着上面这段代码将进入selfInterrupt()，所以正常情况下，下面应该返回false</span></span>
    <span class="hljs-comment"><span class="hljs-comment">// 这个方法非常重要，应该说真正的线程挂起，然后被唤醒后去获取锁，都在这个方法里了</span></span>
    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">acquireQueued</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Node node, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> arg)</span></span></span><span class="hljs-function"> </span></span>{
        <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> failed = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>;
        <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> {
            <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> interrupted = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>;
            <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (;;) {
                <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Node p = node.predecessor();
                <span class="hljs-comment"><span class="hljs-comment">// p == head 说明当前节点虽然进到了阻塞队列，但是是阻塞队列的第一个，因为它的前驱是head</span></span>
                <span class="hljs-comment"><span class="hljs-comment">// 注意，阻塞队列不包含head节点，head一般指的是占有锁的线程，head后面的才称为阻塞队列</span></span>
                <span class="hljs-comment"><span class="hljs-comment">// 所以当前节点可以去试抢一下锁</span></span>
                <span class="hljs-comment"><span class="hljs-comment">// 这里我们说一下，为什么可以去试试：</span></span>
                <span class="hljs-comment"><span class="hljs-comment">// 首先，它是队头，这个是第一个条件，其次，当前的head有可能是刚刚初始化的node，</span></span>
                <span class="hljs-comment"><span class="hljs-comment">// enq(node) 方法里面有提到，head是延时初始化的，而且new Node()的时候没有设置任何线程</span></span>
                <span class="hljs-comment"><span class="hljs-comment">// 也就是说，当前的head不属于任何一个线程，所以作为队头，可以去试一试，</span></span>
                <span class="hljs-comment"><span class="hljs-comment">// tryAcquire已经分析过了, 忘记了请往前看一下，就是简单用CAS试操作一下state</span></span>
                <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (p == head &amp;&amp; tryAcquire(arg)) {
                    setHead(node);
                    p.next = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-comment"><span class="hljs-comment">// help GC</span></span>
                    failed = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>;
                    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> interrupted;
                }
                <span class="hljs-comment"><span class="hljs-comment">// 到这里，说明上面的if分支没有成功，要么当前node本来就不是队头，</span></span>
                <span class="hljs-comment"><span class="hljs-comment">// 要么就是tryAcquire(arg)没有抢赢别人，继续往下看</span></span>
                <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;
                    parkAndCheckInterrupt())
                    interrupted = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>;
            }
        } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> {
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (failed)
                cancelAcquire(node);
        }
    }

    <span class="hljs-comment"><span class="hljs-comment">/**
     * Checks and updates status for a node that failed to acquire.
     * Returns true if thread should block. This is the main signal
     * control in all acquire loops.  Requires that pred == node.prev
     *
     * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> pred node's predecessor holding status
     * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> node the node
     * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@code</span></span></span><span class="hljs-comment"> true} if thread should block
     */</span></span>
    <span class="hljs-comment"><span class="hljs-comment">// 刚刚说过，会到这里就是没有抢到锁呗，这个方法说的是："当前线程没有抢到锁，是否需要挂起当前线程？"</span></span>
    <span class="hljs-comment"><span class="hljs-comment">// 第一个参数是前驱节点，第二个参数才是代表当前线程的节点</span></span>
    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">shouldParkAfterFailedAcquire</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Node pred, Node node)</span></span></span><span class="hljs-function"> </span></span>{
        <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ws = pred.waitStatus;
        <span class="hljs-comment"><span class="hljs-comment">// 前驱节点的 waitStatus == -1 ，说明前驱节点状态正常，当前线程需要挂起，直接可以返回true</span></span>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ws == Node.SIGNAL)
            <span class="hljs-comment"><span class="hljs-comment">/*
             * This node has already set status asking a release
             * to signal it, so it can safely park.
             */</span></span>
            <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>;

        <span class="hljs-comment"><span class="hljs-comment">// 前驱节点 waitStatus大于0 ，之前说过，大于0 说明前驱节点取消了排队。这里需要知道这点：</span></span>
        <span class="hljs-comment"><span class="hljs-comment">// 进入阻塞队列排队的线程会被挂起，而唤醒的操作是由前驱节点完成的。</span></span>
        <span class="hljs-comment"><span class="hljs-comment">// 所以下面这块代码说的是将当前节点的prev指向waitStatus&lt;=0的节点，</span></span>
        <span class="hljs-comment"><span class="hljs-comment">// 简单说，就是为了找个好爹，因为你还得依赖它来唤醒呢，如果前驱节点取消了排队，</span></span>
        <span class="hljs-comment"><span class="hljs-comment">// 找前驱节点的前驱节点做爹，往前循环总能找到一个好爹的</span></span>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ws &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) {
            <span class="hljs-comment"><span class="hljs-comment">/*
             * Predecessor was cancelled. Skip over predecessors and
             * indicate retry.
             */</span></span>
            <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> {
                node.prev = pred = pred.prev;
            } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (pred.waitStatus &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>);
            pred.next = node;
        } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {
            <span class="hljs-comment"><span class="hljs-comment">/*
             * waitStatus must be 0 or PROPAGATE.  Indicate that we
             * need a signal, but don't park yet.  Caller will need to
             * retry to make sure it cannot acquire before parking.
             */</span></span>
            <span class="hljs-comment"><span class="hljs-comment">// 仔细想想，如果进入到这个分支意味着什么</span></span>
            <span class="hljs-comment"><span class="hljs-comment">// 前驱节点的waitStatus不等于-1和1，那也就是只可能是0，-2，-3</span></span>
            <span class="hljs-comment"><span class="hljs-comment">// 在我们前面的源码中，都没有看到有设置waitStatus的，所以每个新的node入队时，waitStatu都是0</span></span>
            <span class="hljs-comment"><span class="hljs-comment">// 用CAS将前驱节点的waitStatus设置为Node.SIGNAL(也就是-1)</span></span>
            compareAndSetWaitStatus(pred, ws, Node.SIGNAL);
        }
        <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>;
    }

    <span class="hljs-comment"><span class="hljs-comment">// private static boolean shouldParkAfterFailedAcquire(Node pred, Node node)</span></span>
    <span class="hljs-comment"><span class="hljs-comment">// 这个方法结束根据返回值我们简单分析下：</span></span>
    <span class="hljs-comment"><span class="hljs-comment">// 如果返回true, 说明前驱节点的waitStatus==-1，是正常情况，那么当前线程需要被挂起，等待以后被唤醒</span></span>
    <span class="hljs-comment"><span class="hljs-comment">//        我们也说过，以后是被前驱节点唤醒，就等着前驱节点拿到锁，然后释放锁的时候叫你好了</span></span>
    <span class="hljs-comment"><span class="hljs-comment">// 如果返回false, 说明当前不需要被挂起，为什么呢？往后看</span></span>

    <span class="hljs-comment"><span class="hljs-comment">// 跳回到前面是这个方法</span></span>
    <span class="hljs-comment"><span class="hljs-comment">// if (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span></span>
    <span class="hljs-comment"><span class="hljs-comment">//                parkAndCheckInterrupt())</span></span>
    <span class="hljs-comment"><span class="hljs-comment">//                interrupted = true;</span></span>

    <span class="hljs-comment"><span class="hljs-comment">// 1. 如果shouldParkAfterFailedAcquire(p, node)返回true，</span></span>
    <span class="hljs-comment"><span class="hljs-comment">// 那么需要执行parkAndCheckInterrupt():</span></span>

    <span class="hljs-comment"><span class="hljs-comment">// 这个方法很简单，因为前面返回true，所以需要挂起线程，这个方法就是负责挂起线程的</span></span>
    <span class="hljs-comment"><span class="hljs-comment">// 这里用了LockSupport.park(this)来挂起线程，然后就停在这里了，等待被唤醒=======</span></span>
    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parkAndCheckInterrupt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{
        LockSupport.park(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>);
        <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Thread.interrupted();
    }

    <span class="hljs-comment"><span class="hljs-comment">// 2. 接下来说说如果shouldParkAfterFailedAcquire(p, node)返回false的情况</span></span>

   <span class="hljs-comment"><span class="hljs-comment">// 仔细看shouldParkAfterFailedAcquire(p, node)，我们可以发现，其实第一次进来的时候，一般都不会返回true的，原因很简单，前驱节点的waitStatus=-1是依赖于后继节点设置的。也就是说，我都还没给前驱设置-1呢，怎么可能是true呢，但是要看到，这个方法是套在循环里的，所以第二次进来的时候状态就是-1了。</span></span>

    <span class="hljs-comment"><span class="hljs-comment">// 解释下为什么shouldParkAfterFailedAcquire(p, node)返回false的时候不直接挂起线程：</span></span>
    <span class="hljs-comment"><span class="hljs-comment">// =&gt; 是为了应对在经过这个方法后，node已经是head的直接后继节点了。剩下的读者自己想想吧。</span></span>
}
</code></pre>
<p>说到这里，也就明白了，多看几遍 <code>final boolean acquireQueued(final Node node, int arg)</code> 这个方法吧。自己推演下各个分支怎么走，哪种情况下会发生什么，走到哪里。</p>
<span id="toc2"></span><h2 id="%E8%A7%A3%E9%94%81%E6%93%8D%E4%BD%9C">解锁操作</h2>
<p>最后，就是还需要介绍下唤醒的动作了。我们知道，正常情况下，如果线程没获取到锁，线程会被 <code>LockSupport.park(this);</code> 挂起停止，等待被唤醒。</p>
<pre><code class="lang-java hljs"><span class="hljs-comment"><span class="hljs-comment">// 唤醒的代码还是比较简单的，你如果上面加锁的都看懂了，下面都不需要看就知道怎么回事了</span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unlock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{
    sync.release(<span class="hljs-number"><span class="hljs-number">1</span></span>);
}

<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">release</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> arg)</span></span></span><span class="hljs-function"> </span></span>{
    <span class="hljs-comment"><span class="hljs-comment">// 往后看吧</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tryRelease(arg)) {
        Node h = head;
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (h != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; h.waitStatus != <span class="hljs-number"><span class="hljs-number">0</span></span>)
            unparkSuccessor(h);
        <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>;
    }
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>;
}

<span class="hljs-comment"><span class="hljs-comment">// 回到ReentrantLock看tryRelease方法</span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tryRelease</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> releases)</span></span></span><span class="hljs-function"> </span></span>{
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> c = getState() - releases;
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Thread.currentThread() != getExclusiveOwnerThread())
        <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalMonitorStateException();
    <span class="hljs-comment"><span class="hljs-comment">// 是否完全释放锁</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> free = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>;
    <span class="hljs-comment"><span class="hljs-comment">// 其实就是重入的问题，如果c==0，也就是说没有嵌套锁了，可以释放了，否则还不能释放掉</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c == <span class="hljs-number"><span class="hljs-number">0</span></span>) {
        free = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>;
        setExclusiveOwnerThread(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>);
    }
    setState(c);
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> free;
}

<span class="hljs-comment"><span class="hljs-comment">/**
 * Wakes up node's successor, if one exists.
 *
 * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> node the node
 */</span></span>
<span class="hljs-comment"><span class="hljs-comment">// 唤醒后继节点</span></span>
<span class="hljs-comment"><span class="hljs-comment">// 从上面调用处知道，参数node是head头结点</span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unparkSuccessor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Node node)</span></span></span><span class="hljs-function"> </span></span>{
    <span class="hljs-comment"><span class="hljs-comment">/*
     * If status is negative (i.e., possibly needing signal) try
     * to clear in anticipation of signalling.  It is OK if this
     * fails or if status is changed by waiting thread.
     */</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ws = node.waitStatus;
    <span class="hljs-comment"><span class="hljs-comment">// 如果head节点当前waitStatus&lt;0, 将其修改为0</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ws &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>)
        compareAndSetWaitStatus(node, ws, <span class="hljs-number"><span class="hljs-number">0</span></span>);
    <span class="hljs-comment"><span class="hljs-comment">/*
     * Thread to unpark is held in successor, which is normally
     * just the next node.  But if cancelled or apparently null,
     * traverse backwards from tail to find the actual
     * non-cancelled successor.
     */</span></span>
    <span class="hljs-comment"><span class="hljs-comment">// 下面的代码就是唤醒后继节点，但是有可能后继节点取消了等待（waitStatus==1）</span></span>
    <span class="hljs-comment"><span class="hljs-comment">// 从队尾往前找，找到waitStatus&lt;=0的所有节点中排在最前面的</span></span>
    Node s = node.next;
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (s == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> || s.waitStatus &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) {
        s = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>;
        <span class="hljs-comment"><span class="hljs-comment">// 从后往前找，仔细看代码，不必担心中间有节点取消(waitStatus==1)的情况</span></span>
        <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Node t = tail; t != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; t != node; t = t.prev)
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (t.waitStatus &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>)
                s = t;
    }
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (s != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>)
        <span class="hljs-comment"><span class="hljs-comment">// 唤醒线程</span></span>
        LockSupport.unpark(s.thread);
}
</code></pre>
<p>唤醒线程以后，被唤醒的线程将从以下代码中继续往前走：</p>
<pre><code class="lang-java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parkAndCheckInterrupt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{
    LockSupport.park(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-comment"><span class="hljs-comment">// 刚刚线程被挂起在这里了</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Thread.interrupted();
}
<span class="hljs-comment"><span class="hljs-comment">// 又回到这个方法了：acquireQueued(final Node node, int arg)，这个时候，node的前驱是head了</span></span>
</code></pre>
<p>好了，后面就不分析源码了，剩下的还有问题自己去仔细看看代码吧。</p>
<span id="toc3"></span><h2 id="%E6%80%BB%E7%BB%93">总结</h2>
<p>总结一下吧。</p>
<p>在并发环境下，加锁和解锁需要以下三个部件的协调：</p>
<ol>
<li>锁状态。我们要知道锁是不是被别的线程占有了，这个就是 state 的作用，它为 0 的时候代表没有线程占有锁，可以去争抢这个锁，用 CAS 将 state 设为 1，如果 CAS 成功，说明抢到了锁，这样其他线程就抢不到了，如果锁重入的话，state进行+1 就可以，解锁就是减 1，直到 state 又变为 0，代表释放锁，所以 lock() 和 unlock() 必须要配对啊。然后唤醒等待队列中的第一个线程，让其来占有锁。</li>
<li>线程的阻塞和解除阻塞。AQS 中采用了 LockSupport.park(thread) 来挂起线程，用 unpark 来唤醒线程。</li>
<li>阻塞队列。因为争抢锁的线程可能很多，但是只能有一个线程拿到锁，其他的线程都必须等待，这个时候就需要一个 queue 来管理这些线程，AQS 用的是一个 FIFO 的队列，就是一个链表，每个 node 都持有后继节点的引用。AQS 采用了 CLH 锁的变体来实现，感兴趣的读者可以参考这篇文章<a href="http://coderbee.net/index.php/concurrent/20131115/577">关于CLH的介绍</a>，写得简单明了。</li>
</ol>
<span id="toc4"></span><h2 id="%E7%A4%BA%E4%BE%8B%E5%9B%BE%E8%A7%A3%E6%9E%90">示例图解析</h2>
<p>下面属于回顾环节，用简单的示例来说一遍，如果上面的有些东西没看懂，这里还有一次帮助你理解的机会。</p>
<p>首先，第一个线程调用 reentrantLock.lock()，翻到最前面可以发现，tryAcquire(1) 直接就返回 true 了，结束。只是设置了 state=1，连 head 都没有初始化，更谈不上什么阻塞队列了。要是线程 1 调用 unlock() 了，才有线程 2 来，那世界就太太太平了，完全没有交集嘛，那我还要 AQS 干嘛。</p>
<p>如果线程 1 没有调用 unlock() 之前，线程 2 调用了 lock(), 想想会发生什么？</p>
<p>线程 2 会初始化 head【new Node()】，同时线程 2 也会插入到阻塞队列并挂起 (注意看这里是一个 for 循环，而且设置 head 和 tail 的部分是不 return 的，只有入队成功才会跳出循环)</p>
<pre><code class="lang-java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Node </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">enq</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Node node)</span></span></span><span class="hljs-function"> </span></span>{
    <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (;;) {
        Node t = tail;
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (t == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// Must initialize</span></span>
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (compareAndSetHead(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Node()))
                tail = head;
        } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {
            node.prev = t;
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (compareAndSetTail(t, node)) {
                t.next = node;
                <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> t;
            }
        }
    }
}
</code></pre>
<p>首先，是线程 2 初始化 head 节点，此时 head==tail, waitStatus==0</p>
<p><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/aqs-1.png" alt="aqs-1"></p>
<p>然后线程 2 入队：</p>
<p><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/aqs-2.png" alt="aqs-2"></p>
<p>同时我们也要看此时节点的 waitStatus，我们知道 head 节点是线程 2 初始化的，此时的 waitStatus 没有设置， java 默认会设置为 0，但是到 shouldParkAfterFailedAcquire 这个方法的时候，线程 2 会把前驱节点，也就是 head 的waitStatus设置为-1。</p>
<p>那线程 2 节点此时的 waitStatus 是多少呢，由于没有设置，所以是 0；</p>
<p>如果线程3此时再进来，直接插到线程2的后面就可以了，此时线程 3 的 waitStatus 是 0，到 shouldParkAfterFailedAcquire 方法的时候把前驱节点线程 2 的 waitStatus 设置为 -1。</p>
<p><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/aqs-3.png" alt="aqs-3"></p>
<p>这里可以简单说下 waitStatus 中 SIGNAL(-1) 状态的意思，Doug Lea 注释的是：代表后继节点需要被唤醒。也就是说这个 waitStatus 其实代表的不是自己的状态，而是后继节点的状态，我们知道，每个 node 在入队的时候，都会把前驱节点的状态改为 SIGNAL，然后阻塞，等待被前驱唤醒。这里涉及的是两个问题：有线程取消了排队、唤醒操作。其实本质是一样的，读者也可以顺着 “waitStatus代表后继节点的状态” 这种思路去看一遍源码。</p>
<p>（全文完）</p>


            <div id="comment">
                

<h4 data-toc-skip="" style="color: #5694ca; margin-bottom: 1.5em; border-bottom: 1px solid #ccc; line-height: 2em;">评论区</h4>

<div id="vcomments" class="comments-block"><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/12.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/12.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                徐涛
                <span class="pull-right">2017-11-15 20:42</span></h5> <p><p>大神，这里的理解是不是有点问题。
                if (p == head &amp;&amp; tryAcquire(arg)) {
                    setHead(node);
                    p.next = null; // help GC
                    failed = false;
                    return interrupted;
                }
这里保留head为刚开始的new Node()不好吗？为什么要重新设置一下head呢？</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                HongJie
                <span class="pull-right">2017-11-16 10:04</span></h5> <p><p>我稍微美化一下：</p>
<pre><code class="lang-java hljs"><span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Node p = node.predecessor();
<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (p == head &amp;&amp; tryAcquire(arg)) {
     setHead(node); 
     p.next = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-comment"><span class="hljs-comment">// help GC</span></span>
     failed = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>;
     <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> interrupted;
 }
</code></pre>
<p>这里保留head为刚开始的new Node()不好吗？为什么要重新设置一下head呢？</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                HongJie
                <span class="pull-right">2017-11-16 10:07</span></h5> <p><p>假设不调用 setHead(node)，我们假设此时 A 持有这个锁，head 是 new Node() 那个空节点。</p>
<p>A 持有的锁用完了，释放锁，唤醒后继节点 B。后继节点 B 从 parkAndCheckInterrupt() 这个方法返回，注意这里的 for 循环。然后调用 final Node p = node.predecessor(); 这个方法，那么这个时候，p == head 就不成立了，也就进不到 tryAcquire(arg) 这里去获取锁。</p>
<pre><code class="lang-java hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (;;) {
    <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Node p = node.predecessor();
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (p == head &amp;&amp; tryAcquire(arg)) {
        <span class="hljs-comment"><span class="hljs-comment">// 进到这里，说明获取到锁了</span></span>
        setHead(node);
        p.next = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-comment"><span class="hljs-comment">// help GC</span></span>
        failed = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>;
        <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> interrupted;
    }
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;
        parkAndCheckInterrupt())
        interrupted = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>;
}
</code></pre>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                HongJie
                <span class="pull-right">2017-11-16 10:12</span></h5> <p><p>另一处。既然当前线程获取到了锁，它就不应该再是阻塞队列的一员。如果没有 setHead 这一步，下面这个方法就不准确了：</p>
<pre><code class="lang-java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> Collection&lt;Thread&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getQueuedThreads</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{
    ArrayList&lt;Thread&gt; list = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;Thread&gt;();
    <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Node p = tail; p != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; p = p.prev) {
        Thread t = p.thread;
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (t != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-comment"><span class="hljs-comment">// 注意这里</span></span>
            list.add(t);
    }
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> list;
}
</code></pre>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div></div></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/12.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/12.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                徐涛
                <span class="pull-right">2017-11-16 11:24</span></h5> <p><p>谢谢！
另外我感觉AQS里面的waitStatus不是很好理解，有时候-1代表后续节点是不是需要unpark，1又代表自己是被cancel掉。有时候代表别人的状态，有时候代表自己的状态。   都用waitStatus表示自己的状态不好吗？</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/16.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/16.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                spjich
                <span class="pull-right">2017-11-30 17:19</span></h5> <p><pre><code class="lang-java hljs"><span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> failed = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">try</span></span> {
    <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> interrupted = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>;
    <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (;;) {
        <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Node p = node.predecessor();
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (p == head &amp;&amp; tryAcquire(arg)) {
            setHead(node);
            p.next = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-comment"><span class="hljs-comment">// help GC</span></span>
            failed = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>;
            <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> interrupted;
        }
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;
            parkAndCheckInterrupt())
            interrupted = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>;
    }
} <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> {
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (failed)
        cancelAcquire(node);
}
</code></pre>
<p>第一个问题：这个finally里的cancelAcquire 似乎永远都不会被执行吧
第二个问题：为什么都是要从tail往前找第一个状态是非CANCEL的节点呢，如果从head往后找第一个状态是非CANCEL的话效率会不会高一点</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                HongJie
                <span class="pull-right">2017-12-07 14:40</span></h5> <p><p>非常抱歉这么久才回复你。你看文章看得很仔细?。</p>
<p>第一个问题：这里的 failed 确实永远都不会为 true，cancelAcquire() 永远不会得到执行。那为什么要这么写呢，如果你看了后面的两篇，可能会有些体会，这部分其实是用于响应中断或超时的，你可以参考 <code>doAcquireNanos(int arg, long nanosTimeout)</code> 或 <code>doAcquireInterruptibly(int arg)</code>。在这个方法中确实是没用的，这更像是模板代码吧。</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                HongJie
                <span class="pull-right">2017-12-07 14:40</span></h5> <p><p>第二个问题：你应该说的是 <code>unparkSuccessor(Node node)</code> 这个方法吧。</p>
<pre><code class="lang-java hljs">    Node s = node.next;
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (s == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> || s.waitStatus &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) {
        s = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>;
        <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Node t = tail; t != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; t != node; t = t.prev)
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (t.waitStatus &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>)
                s = t;
    }
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (s != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>)
        LockSupport.unpark(s.thread);
</code></pre>
<p>首先，第一行代码先检测 head 的后继节点，只有当此时的后继节点不存在或者这个后继节点取消了才开始从后往前找，所以大部分情况下，其实不会发生从后往前遍历整个队列的情况。（后继节点取消很正常，但是某节点在入队的时候，如果发现前驱是取消状态，前驱节点是会被请出队列的）</p>
<p>你说的这个问题的答案在 <code>addWaiter(Node mode)</code>方法中，看下面的代码：</p>
<pre><code class="lang-java hljs">    Node pred = tail;
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pred != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) {
        node.prev = pred;
        <span class="hljs-comment"><span class="hljs-comment">// 1. 先设置的 tail</span></span>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (compareAndSetTail(pred, node)) {
            <span class="hljs-comment"><span class="hljs-comment">// 2. 设置前驱节点的后继节点为当前节点</span></span>
            pred.next = node;
            <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> node;
        }
    }
</code></pre>
<p>所以，这里存在并发问题：从前往后寻找不一定能找到刚刚加入队列的后继节点。</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/16.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/16.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                spjich
                <span class="pull-right">2017-12-07 15:13</span></h5> <p><p>恩是的，确实如此，源码作者如此设计，巧妙的解决了并发问题。因为先node.prev = pred; 再compareAndSetTail(pred, node) 再 pred.next = node; 这种操作步奏 是安全的，以此为前提，如果从前往后找的话 compareAndSetTail(pred, node) 如果执行完成而pred.next = node; 还未来的及执行的话 新加的tail是无法被遍历到的。多谢作者指点</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div></div></div></div></div></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/14.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/14.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                李晓东
                <span class="pull-right">2018-02-23 18:03</span></h5> <p><p>把addWaiter（mode）的返回值误认为就是enq(node)得返回值，看得我怀疑人生。老板你写的这么风趣、细致、还那么贴心实在是太nice了，非常感谢</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/7.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/7.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                xupeng.zhang
                <span class="pull-right">2018-02-23 20:18</span></h5> <p><p>看了一遍又一遍，一边看文章，一边回过头看代码，一边推演整个流程的模型。总算看懂了。</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/6.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/6.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                hello2333
                <span class="pull-right">2018-02-26 12:31</span></h5> <p><p>感觉Java的monitor和AQS的目的和实现思路很相似，为什么还要再实现一遍AQS呢？</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                HongJie
                <span class="pull-right">2018-02-26 14:11</span></h5> <p><p>monitor 功能太单一了，就是获取独占锁，</p>
<p>AQS 相比 monitor，功能要丰富很多，比如我们可以设置超时时间，可以用线程中断进行退出，可以选择公平/非公平模式等，你可以先看看后面关于 AQS 介绍的<a href="https://javadoop.com/post/AbstractQueuedSynchronizer-2">第二篇</a>和<a href="https://javadoop.com/post/AbstractQueuedSynchronizer-3">第三篇</a>，然后就会发现，采用 AQS 可以实现很多灵活的场景</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div></div></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/3.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/3.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                冯健
                <span class="pull-right">2018-03-03 22:12</span></h5> <p><p>大神，有一个地方还是没搞懂。
acquireQueued方法里面，第一次调用shouldParkAfterFailedAcquire(p, node)的时候，把前驱节点waitStatus从0改为-1，然后返回false，回到acquireQueued方法，再尝试拿一次锁，然后第二次调用shouldParkAfterFailedAcquire返回true，调用parkAndCheckInterrupt()挂起线程。
那么，如果在某线程B还没有挂起之前，前驱节点的线程A发现自己waitStatus为-1直接unpark，然后刚刚的线程B才挂起。那不就没人能唤醒它了吗？它是怎么保证被唤醒的？</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                HongJie
                <span class="pull-right">2018-03-05 10:05</span></h5> <p><p>非常抱歉，这次的回复很不及时~</p>
<p>你应该已经把流程摸清楚了，我就说一点就可以了，你的疑问其实在 unpark() 方法上。</p>
<p>1、如果一个线程 park 了，那么调用 unpark(thread) 这个线程会被唤醒；</p>
<p>2、如果一个线程先被调用了 unpark，那么下一个 park(thread) 操作不会挂起线程。</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/3.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/3.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                冯健
                <span class="pull-right">2018-03-05 10:51</span></h5> <p><p>原来是这样，那就没有问题了。
十分感谢，回复非常快。</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/6.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/6.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                hello2333
                <span class="pull-right">2018-03-06 19:07</span></h5> <p><p>假设t1时刻A线程执行addWaiter，在队尾加入了一个新的nodeA，执行结束；
t2时刻，B线程执行unparkSuccessor，在for循环中突然被线程C打断；
线程C程执行addWaiter，在队尾加入了一个新的nodeC，执行结束；
再回到线程B，此时线程B仍然无法访问到节点nodeC是吧？</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <div><div class="media"><div class="media-left" style="display: none;"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="img-circle" style="display: inline; width: 30px; height: 30px;">
                HongJie
                <span class="pull-right">2018-03-06 19:14</span></h5> <p><p>我表示没有理解你的意思?</p>
<p>第二句话稍微再具体一点点</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div></div></div></div></div></div></div></div></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/9.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/9.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                你猜
                <span class="pull-right">2018-03-09 11:49</span></h5> <p><p>你是廖红杰吗</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/9.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/9.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                你猜
                <span class="pull-right">2018-03-09 11:50</span></h5> <p><p>打错字了，廖鸿杰</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                HongJie
                <span class="pull-right">2018-03-09 12:51</span></h5> <p><p>你猜?</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div></div></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/9.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/9.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                余谦
                <span class="pull-right">2018-03-14 16:20</span></h5> <p><p>公平锁对于已经在队列里面的线程其实是不公平的，已经在队列中的线程只能顺序获得锁，是吗？</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                HongJie
                <span class="pull-right">2018-03-14 16:24</span></h5> <p><p>你说的这个问题很简单，建议你看下下一篇文章，开头第一小节解释了公平锁和非公平锁的区别。</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div></div></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/16.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/16.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                L
                <span class="pull-right">2018-03-23 19:50</span></h5> <p><p>public final boolean hasQueuedPredecessors() {
        // The correctness of this depends on head being initialized
        // before tail and on head.next being accurate if the current
        // thread is first in queue.
        Node t = tail; // Read fields in reverse initialization order
        Node h = head;
        Node s;
        return h != t &amp;&amp;
            ((s = h.next) == null || s.thread != Thread.currentThread());
    }
请教大神，为什么要先读tail，再读head，我猜是为了增加tail为null的可能性，可是增加这种可能性的目的呢？</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                HongJie
                <span class="pull-right">2018-03-26 18:19</span></h5> <p><p>非常抱歉，周末的留言一般我很难及时回复，然后就只能等工作日想起来的时候回复了?</p>
<p>你这个问题可真是细啊，细心的程序员~~~</p>
<p>我把评论限制了 1024 个字符，所以分两条了。。。</p>
<p>看下面这段代码，如果是第一个 node 进队列的情况：</p>
<pre><code class="lang-java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Node </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">enq</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Node node)</span></span></span><span class="hljs-function"> </span></span>{
    <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (;;) {
        Node t = tail;
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (t == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) {
            <span class="hljs-comment"><span class="hljs-comment">// 1. 设置 head </span></span>
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (compareAndSetHead(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Node()))
                <span class="hljs-comment"><span class="hljs-comment">// 2. 设置 tail</span></span>
                tail = head;
        } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {
            node.prev = t;
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (compareAndSetTail(t, node)) {
                t.next = node;
                <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> t;
            }
        }
    }
}
</code></pre>
<p>也就是说，先有 head 然后才有 tail。</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                HongJie
                <span class="pull-right">2018-03-26 18:19</span></h5> <p><p>回到 hasQueuedPredecessors：</p>
<pre><code class="lang-java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hasQueuedPredecessors</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{
    Node t = tail;
    Node h = head;
    Node s;
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> h != t &amp;&amp;
        ((s = h.next) == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> || s.thread != Thread.currentThread());
}
</code></pre>
<p>有可能的情况就是 t 为 null，h 不为 null 对吧，这个时候返回值取决于 h.next。</p>
<p>如果调换一下 <code>Node t = tail;</code> 和 <code>Node h = head;</code> 那么可能出现 <strong>h 为 null，t 不为 null</strong>，这个方法会返回 false。</p>
<p>但是其实不对的，很可能这个间隙是有节点 enq 成功的。</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div></div></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/2.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/2.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                袋鼠
                <span class="pull-right">2018-04-01 12:38</span></h5> <p><p>看了评论区，关于unparkSuccessor(Node node)方法中从后往前找的描述，我了解了从后往前找的原因，但是还有个疑问想请教。</p>
<p>我们不应该从前往后找吗？这样，先入列的，等待之后，先获得锁吗？</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/2.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/2.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                袋鼠
                <span class="pull-right">2018-04-01 23:01</span></h5> <p><p>我问的这个问题，我再看看，自己再思考一下！！！
先谢过。</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                HongJie
                <span class="pull-right">2018-04-02 11:07</span></h5> <p><p>非常抱歉哈，一般周末留言的问题我确实经常不能很及时回复。</p>
<pre><code class="lang-java hljs">        Node s = node.next;
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (s == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> || s.waitStatus &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) {
            s = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>;
            <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Node t = tail; t != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; t != node; t = t.prev)
                <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (t.waitStatus &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>)
                    s = t;
        }
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (s != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>)
            LockSupport.unpark(s.thread);
</code></pre>
<p>这段代码不是说就是从后往前找，而是当 s.next “不正常” 的时候才是从后往前找，大概率情况下，还是不需要遍历的。</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/2.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/2.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                袋鼠
                <span class="pull-right">2018-04-04 22:52</span></h5> <p><p>感谢回复，又看了几遍理解了，谢谢！</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div></div></div></div></div></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/2.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/2.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                袋鼠
                <span class="pull-right">2018-04-01 12:40</span></h5> <p><p>自己也是在一步步研究AQS，有些头大</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/2.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/2.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                sky
                <span class="pull-right">2018-04-09 11:55</span></h5> <p><p>大神，为什么所说的阻塞队列不包含 head 节点</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                HongJie
                <span class="pull-right">2018-04-09 12:40</span></h5> <p><p>因为 head 节点是当前独占锁的持有者。</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/2.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/2.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                sky
                <span class="pull-right">2018-04-09 12:53</span></h5> <p><p>感谢，获益匪浅</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div></div></div></div></div></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/17.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/17.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                夏天
                <span class="pull-right">2018-04-09 20:39</span></h5> <p><p>我想问一下博主，为什么共享锁的node节点是new了一个节点，独占是null呢</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                HongJie
                <span class="pull-right">2018-04-09 20:47</span></h5> <p><p>其实我也不知道是为什么???</p>
<p>大神 Doug Lea 的想法应该是(我怎么知道他到底怎么想的)：<code>nextWaiter</code> 这个属性在这个时候是没用的，因为它用来实现 Condition，那么不用白不用，虽然不好理解，可是充分利用资源呀，不然还得自己额外定义一个用来标识模式的属性。</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div></div></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/2.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/2.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                sky
                <span class="pull-right">2018-04-09 22:19</span></h5> <p><p>public final void acquire(int arg) {
        if (!tryAcquire(arg) &amp;&amp;
            acquireQueued(addWaiter(Node.EXCLUSIVE), arg))
            selfInterrupt();
    }</p>
<p>博主您好，请问这个里如果同步状态tryAcquire(arg)获取失败，就构造一个同步节点通过addWaiter(Node.EXCLUSIVE)将节点添加到尾部，如果条件成立执行  selfInterrupt()会中断当前线程吗 selfInterrupt()的用途不是太明白，有的书籍上说acquire(int arg)方法对中断不敏感，不会将获取同步状态失败的线程从同步队列中移除。烦请博主大大给点指点下哈</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                HongJie
                <span class="pull-right">2018-04-09 22:27</span></h5> <p><p>你说的这个很简单，acquireQueued 返回值代表的是：是否被中断过。但是，不管是否被中断过，acquireQueued 出来以后，线程的中断状态一定是 false，所以如果发生过中断，要重新设置中断状态。</p>
<p>虽然 acquire(int arg) 确实是不关心中断的，但是它会保持这个状态，如果客户端想要知道是否发生过中断的话，还是可以知道的。因为中断情况下，中断状态虽然中间丢过，但是 selfInterrupt() 会设置回去。</p>
<p>会实际受到中断影响的是另一个方法 acquireInterruptibly(int arg)，这个方法会通过抛出异常的方式告诉客户端。</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div></div></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/2.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/2.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                sky
                <span class="pull-right">2018-04-09 22:40</span></h5> <p><p>  final Node predecessor() throws NullPointerException {
            Node p = prev;
            if (p == null)
                throw new NullPointerException();
            else
                return p;
        }</p>
<p>  // p == head 说明当前节点虽然进到了阻塞队列，但是是阻塞队列的第一个，因为它的前驱是head
                // 注意，阻塞队列不包含head节点，head一般指的是占有锁的线程，head后面的才称为阻塞队列
                // 所以当前节点可以去试抢一下锁
                // 这里我们说一下，为什么可以去试试：
                // 首先，它是队头，这个是第一个条件，其次，当前的head有可能是刚刚初始化的node，
                // enq(node) 方法里面有提到，head是延时初始化的，而且new Node()的时候没有设置任何线程
                // 也就是说，当前的head不属于任何一个线程，所以作为队头，可以去试一试，</p>
<p>博主，如果是在enq(node)中new head的话，那说明只有head这一个节点把，也就没有前驱节点了，那么 Node p = prev; p就为null了把，就会直接抛异常了把</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                HongJie
                <span class="pull-right">2018-04-09 22:47</span></h5> <p><p>下次评论的时候，记得要使用 markdown 语法，不然样式很难看。</p>
<p>你先认真看看吧，自己推导推导，还是挺有意思的，而且整个并发包源码很多地方都用了 AQS 框架。</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div></div></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/2.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/2.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                sky
                <span class="pull-right">2018-04-09 23:08</span></h5> <p><p>博主：if (shouldParkAfterFailedAcquire(p, node) &amp;&amp;
                 parkAndCheckInterrupt())
                interrupted = true;
这里可以解释下吗？上面的没有看懂。。。</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                HongJie
                <span class="pull-right">2018-04-09 23:13</span></h5> <p><p>三言两语还是比较难说清楚的。随便说几句不严谨的，具体的还是得仔细看每一行代码。</p>
<p>shouldParkAfterFailedAcquire：判断是否应该要挂起，如果需要，进到 parkAndCheckInterrupt 进行挂起，等待别人唤醒它。</p>
<p>。。。假设过了很久。。。被唤醒了，需要判断是否是被中断唤醒的还是前驱节点用完了锁正常唤醒自己的。</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/2.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/2.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                sky
                <span class="pull-right">2018-04-09 23:18</span></h5> <p><p>好的?</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div></div></div></div></div></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/2.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/2.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                sky
                <span class="pull-right">2018-04-11 07:29</span></h5> <p><p>大神，为什么cancelAcquire方法中，要设置node.next = node呢</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/11.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/11.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                石黑龙
                <span class="pull-right">2018-04-12 23:58</span></h5> <p><p>不是很明白head 节点是当前独占锁的持有者的意思(注释也说到head一般指的是占有锁的线程)，请问从何作出这个判断？ 看代码感觉整个阻塞队列（包括head节点）都没有当前占有锁线程的信息。</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                HongJie
                <span class="pull-right">2018-04-13 00:06</span></h5> <p><p>这是隐含的信息，ReentrantLock  具有排他性，lock() 方法要么阻塞，要么顺利拿到锁返回。</p>
<p>当 lock() 返回的时候，我们说当前线程持有了独占锁，而此时的 head 就是当前线程。</p>
<p>（这里说的情况不考虑连 head 都没有初始化的场景）</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/11.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/11.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                石黑龙
                <span class="pull-right">2018-04-13 09:45</span></h5> <p><p>这样的说法很容易让人混淆，应该是得分两种情况考虑:  </p>
<p>1、当前已有别的线程持有锁的时候，head是指向(head.next)下次解锁时即将能持有锁的线程。</p>
<p>2、当持有锁的线程unlock时， head 指向的就是当前持有锁的线程 ，但这个时间非常短，因为head马上又会指向一下个即将能持有锁的线程。</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div></div></div></div></div></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/9.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/9.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                jacky
                <span class="pull-right">2018-04-23 17:44</span></h5> <p><p>你好，谢谢你的博客，有一点我想问一下</p>
<pre><code class="lang-java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cancelAcquire</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Node node)</span></span></span><span class="hljs-function"> </span></span>{
        ...
        <span class="hljs-comment"><span class="hljs-comment">// If we are the tail, remove ourselves.</span></span>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node == tail &amp;&amp; compareAndSetTail(node, pred)) {
            compareAndSetNext(pred, predNext, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>);
        } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {
            <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ws;
            <span class="hljs-comment"><span class="hljs-comment">/* 这里为什么如果不满足条件就唤醒下一位
             * 第一个条件我是理解的 如果pred是head 那么需要唤醒下一位
             * 因为如果前面是pred ==head 那么这个cancel的线程定时醒来后
             * 如果还没有执行赋值，那么此时持有锁的线程正好开始释放锁，
             * 那么会唤醒第一个阻塞的线程，假设这个线程正好是上面的线程
             * 那么如果此时这个cancel的线程不传递这个唤醒，就会造成
             * 其他线程醒不来， 但是为什么下面两个条件的失败也会唤醒后面的线程？
             */</span></span>
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pred != head &amp;&amp;
                ((ws = pred.waitStatus) == Node.SIGNAL ||
                 (ws &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; compareAndSetWaitStatus(pred, ws, Node.SIGNAL))) &amp;&amp;
                pred.thread != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) {
        ...
    }
</code></pre>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                HongJie
                <span class="pull-right">2018-04-23 19:00</span></h5> <p><p>转化一下，如果要进入到 else，需要满足：</p>
<pre><code class="lang-java hljs">(ws = pred.waitStatus) != Node.SIGNAL
&amp;&amp;
ws &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> || (ws &lt;=<span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; compareAndSetWaitStatus(pred, ws, Node.SIGNAL))
</code></pre>
<p>再将其转化为下面两种情况：</p>
<ol>
<li><p>(ws = pred.waitStatus != Node.SIGNAL) &amp;&amp; ws &gt; 0</p>
<p>前驱节点处于 <strong>CANCELLED</strong> 状态，显然是需要唤醒后继节点的，这条很简单</p>
</li>
<li><p>(ws = pred.waitStatus != Node.SIGNAL) </p>
</li>
</ol>
<p>​    &amp;&amp; (ws &lt;= 0) </p>
<p>​    &amp;&amp; (!compareAndSetWaitStatus(pred, ws, Node.SIGNAL))</p>
<p>​    这种情况下，在将前驱设置为 SIGNAL 的时候失败了，我想到的一种情况是，在 CAS 之前前驱设置为了 CANCELLED</p>
<blockquote>
<p>tips: 老鸟的话就算了，新手的话，建议结合 acquireQueued 方法来看，假设里面的 tryAcquire 抛出异常的场景。</p>
</blockquote>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                HongJie
                <span class="pull-right">2018-04-23 19:04</span></h5> <p><p>好像漏了一条: pred.thread == null</p>
<p>这个很简单，head 是 new Node() 的“空节点”，要是不做唤醒后继节点的话，那。。。你懂的</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/9.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/9.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                jacky
                <span class="pull-right">2018-04-23 21:52</span></h5> <p><p>谢谢你的回复，
(ws = pred.waitStatus != Node.SIGNAL) &amp;&amp; ws &gt; 0
前驱节点处于 CANCELLED 状态，显然是需要唤醒后继节点的，这条很简单
如果前驱是cancelled，为什么需要唤醒下一位？
我的理解是，要激活下一位的原因，是怕把真正的激活用在了激活了cancel节点，造成后面的线程醒不了，所以需要激活下一位，
因为需要唤醒下一位，是怕下一位醒不来，如果前驱是cancelled，因为有第一条的限制，pred != head, 说明在上面Skip cancelled predecessors的时候，pred还不是cancel，如果在执行完这个之后，pred变为了cancel也没有关系，因为pred的醒来晚于当前，所以当前线程不可能浪费一次激活的机会，这个浪费跟我的第一条里面的方式一样(释放锁激活了一个cancel节点，如果激活不传递会有问题)，那么说明当前线程不可能是pred激活的，那么说明当前线程的唤醒根本不可能是pred唤醒的，也就是不会存在释放锁的线程激活第一个cancel节点，cancel节点激活当前这个节点</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/9.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/9.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                jacky
                <span class="pull-right">2018-04-23 21:59</span></h5> <p><p>但是如果是这种情况，那么就会直接走pred == head 这个条件了，而不是走pred == null 这个条件, 所以如果走了这个pred.thread == null 这个条件，说明pred != head, 那么head 是 new Node() 的“空节点”就不成立了，不知是不是理解有误</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <div><div class="media"><div class="media-left" style="display: none;"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/9.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/9.png" alt="" class="img-circle" style="display: inline; width: 30px; height: 30px;">
                jacky
                <span class="pull-right">2018-04-23 22:37</span></h5> <p><p>我想说的是，这两个条件执行的前提也是head!=null 如果cancelAcquire一开始过滤cancel节点的时候，pred不是cancel，那么在底下的时候，如果pred的状态变为了cancel，那么已经说明当前线程不可能是pred唤醒的，因为pred醒来的时候，当前线程早已经醒了，所以不会是pred，还有会存在唤醒的可能是，正常释放锁的时候，会唤醒头节点，那么头节点如果是cancel，然后cancel有可能继续在接下来cancel节点醒来的时候，去唤醒他一次，但是如果是这种情况，那么第二个节点在过滤cancel的时候，会过滤掉第一个节点，结果pred变为了head，这样又是不满足第一个条件 pred == head,而不是底下的判断条件</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div><div class="media"><div class="media-left" style="display: none;"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="img-circle" style="display: inline; width: 30px; height: 30px;">
                HongJie
                <span class="pull-right">2018-04-26 21:14</span></h5> <p><p>这两天实在是忙得很。。。</p>
<p>这里我应该是犯了低级错误，此时的情况不可能是 new Node() 的节点，我想应该是前驱调用了 cancelAcquire 方法置 null 了。</p>
<p>上面一条的评论我就先不回复你了，我也有些没完全看懂，改天我看懂了再回复吧。</p>
<p>如果你看懂了，希望你能分享给我 ???</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <div><div class="media"><div class="media-left" style="display: none;"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/9.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/9.png" alt="" class="img-circle" style="display: inline; width: 30px; height: 30px;">
                jacky
                <span class="pull-right">2018-05-04 14:37</span></h5> <p><p>ok，一起交流，最近没有深入下去，现在还是没有完全get到这三个条件的点</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div></div></div></div></div></div></div></div></div></div></div></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/2.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/2.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                lzf8888
                <span class="pull-right">2018-05-11 17:07</span></h5> <p><p>首先，文章写得非常好，代码真是非常的精妙。
JVM的monitor最终是使用了（如果升级为重量锁）mutex，操作系统级的支持；能否这样理解，基于AQS的ReentrantLock不需要操作系统的锁支持了，所以比较轻？而且也不会升级为重量级锁，本身只是个等待队列而已。</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/13.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/13.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                Alan
                <span class="pull-right">2018-05-17 16:03</span></h5> <p><p>do {
                node.prev = pred = pred.prev;
            } while (pred.waitStatus &gt; 0);
            pred.next = node;这一块会不会发生pred对象为null呢？？？？</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/9.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/9.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                kaka
                <span class="pull-right">2018-05-22 11:13</span></h5> <p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hasQueuedPredecessors</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{
    Node t = tail; <span class="hljs-comment"><span class="hljs-comment">// Read fields in reverse initialization order</span></span>
    Node h = head;
    Node s;
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> h != t &amp;&amp;
        ( (s = h.next) == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> || s.thread != Thread.currentThread() );
}
</code></pre><p>1队列非空，2队列第一个节点（非head）非当前线程 满足两个条件返回true， 那么h != t &amp;&amp; (s = h.next) == null 这样一种场景怎么理解</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                HongJie
                <span class="pull-right">2018-05-26 00:48</span></h5> <p><p>不好意思哈，最近太忙了，都没空回复你们的问题，看来我真不是一个合格的博主。</p>
<p>你的问题需要到 enq 找答案：</p>
<pre><code class="lang-java hljs">
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Node </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">enq</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Node node)</span></span></span><span class="hljs-function"> </span></span>{
    <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (;;) {
        Node t = tail;
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (t == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) {
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (compareAndSetHead(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Node()))
                tail = head;
        } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {
            node.prev = t;
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (compareAndSetTail(t, node)) {
                <span class="hljs-comment"><span class="hljs-comment">// 看这里</span></span>
                t.next = node;
                <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> t;
            }
        }
    }
}
</code></pre>
<p>节点入队时，先成为 tail 然后才设置前驱的 next 属性。</p>
<p>那么对应于你的问题，<code>h != t &amp;&amp; h.next == null</code> 对应的就是某个节点现在已经是 tail 了，但是 head.next 还是 null。</p>
<blockquote>
<p>虽然文中没有分析到这个分支，不过还是有些细心的读者对这个很感兴趣的，你也可以往前看下另一个读者的问题，也是针对这个方法的。</p>
</blockquote>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                HongJie
                <span class="pull-right">2018-05-26 00:52</span></h5> <p><p>这里肯定是不会为 null 的，你可以把你认为它可能会为 null 的分析过程描述得详细一些，这样我们比较容易在一个频道上。</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div></div></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/6.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/6.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                PAF_J
                <span class="pull-right">2018-06-07 10:50</span></h5> <p><p>else if (current == getExclusiveOwnerThread()) {
            int nextc = c + acquires;
            if (nextc &lt; 0)
                throw new Error("Maximum lock count exceeded");
            setState(nextc);
            return true;
        }
请教一下，既然线程重入了，说明状态c&gt;0  ，而且acquires=1那么，nextc会有&lt;0的情况吗？</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/11.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/11.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                kenneth
                <span class="pull-right">2018-06-21 17:19</span></h5> <p><p>真的太感谢了。看了好多AQS相关的博客，老是看不懂。这篇文章看起来很顺。感谢！！！</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/16.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/16.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                sharif
                <span class="pull-right">2018-07-09 17:14</span></h5> <p><p>do { node.prev = pred = pred.prev;  } while (pred.waitStatus &gt; 0);<br>pred = pred.prev  这个不是个死循环嘛？
这么循环怎么能成立的呀？麻烦大神给解释一下</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                HongJie
                <span class="pull-right">2018-07-09 17:22</span></h5> <p><p>这里没有死循环呀，一直在沿着队列往前走，找到一个 waitStatus&lt;=0 的节点</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/16.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/16.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                sharif
                <span class="pull-right">2018-07-09 17:33</span></h5> <p><p>我代码理解错了，不好意思??</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div></div></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/3.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/3.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                NJU_YZF
                <span class="pull-right">2018-07-18 14:08</span></h5> <p><p>问：阻塞队列的头结点是什么时候初始化的呢？ 
答： 1. 当前队列为空，2.当有线程阻塞的时候
问： 为什么不在锁的构造器里就先建一个阻塞队列的头结点呢？
答： 如果没有线程竞争锁的话就是浪费一个节点的空间，Doug Lea大师的注释如下。可见大师的代码一点一滴都体现水平。</p>
<pre><code class="hljs cpp"> * CLH queues need a dummy header node to get started. But
 * we don't create them on construction, because it would be wasted
 * effort <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> there is never contention. Instead, the node
 * is constructed <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> head <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> tail pointers are <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> upon first
 * contention.
</code></pre><p>问：阻塞队列的头结点什么时候会被GC呢？
答：当队列里第一个Node节点得到锁后，该节点会被设置成新的头结点。那么原来“老”的头结点由于没有任何引用指向它，就会被GC回收。</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/16.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/16.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                rainDon
                <span class="pull-right">2018-07-27 17:52</span></h5> <p><p>写的很牛逼的样子，其实看起来相当费劲！
我建议作者以例子来说明，例如这篇文章，看了马上就能懂，回头看看作者的这篇博客就没那么难理解了
<a href="https://blog.csdn.net/zs064811/article/details/76996727">https://blog.csdn.net/zs064811/article/details/76996727</a></p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/11.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/11.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                pangzhaojie
                <span class="pull-right">2018-08-20 11:42</span></h5> <p><p>如果你不知道为什么要看这个，我想告诉你，即使你看懂了所有的细节，你可能也不能把你的业务代码写得更好</p>
<p>这句话是什么意思，没太明白</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/11.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/11.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                pangzhaojie
                <span class="pull-right">2018-08-21 08:41</span></h5> <p><p>队列中的线程节点node被唤醒后，node直接变为head，指向原head的指针pred没有被置null，原head节点没法回收吧</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                HongJie
                <span class="pull-right">2018-08-21 08:49</span></h5> <p><pre><code class="lang-java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">acquireQueued</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Node node, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> arg)</span></span></span><span class="hljs-function"> </span></span>{
    ...
        <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (;;) {
            <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Node p = node.predecessor();
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (p == head &amp;&amp; tryAcquire(arg)) {
                <span class="hljs-comment"><span class="hljs-comment">// 拿到锁进来这里</span></span>
                setHead(node);
                p.next = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-comment"><span class="hljs-comment">// help GC</span></span>
                failed = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>;
                <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> interrupted;
            }
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;
                parkAndCheckInterrupt())
                interrupted = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>;
        }
    ...
}
</code></pre>
<p>在 <code>setHead(node)</code> 方法里面：</p>
<pre><code class="lang-java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setHead</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Node node)</span></span></span><span class="hljs-function"> </span></span>{
    head = node;
    node.thread = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>;
    <span class="hljs-comment"><span class="hljs-comment">// 这个</span></span>
    node.prev = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>;
}
</code></pre>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div></div></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/11.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/11.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                pangzhaojie
                <span class="pull-right">2018-08-21 08:54</span></h5> <p><p>看到setHead(node)，这个问题忽略吧</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/17.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/17.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                赵哲彬
                <span class="pull-right">2018-08-21 22:13</span></h5> <p><p>大神你好。请问一下，head节点的属性是不是state，这个state表示当前锁已经被占用几次了。阻塞队列里的node的属性是waitStatus，代表着阻塞队列里节点的状态。这是两个枚举值完全不相关的属性吗？</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/4.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/4.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                zhu
                <span class="pull-right">2018-09-03 15:47</span></h5> <p><pre><code class="lang-java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hasQueuedPredecessors</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{
    Node t = tail;
    Node h = head;
    Node s;
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> h != t &amp;&amp;
        ((s = h.next) == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> || s.thread != Thread.currentThread());
}
</code></pre>
<pre><code class="hljs coffeescript">非常感谢博主的文章，我这里有一点不是很理解，就是刚初始化 fifo 的时候，h=<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Node(); 
 t = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; 这样子 h != t &amp;&amp; (s = h.next) == <span class="hljs-literal"><span class="hljs-literal">null</span></span> 不是为 <span class="hljs-literal"><span class="hljs-literal">true</span></span> 吗， h.next == <span class="hljs-literal"><span class="hljs-literal">null</span></span>; 因为是刚
初始化的节点，这样子不是没有 Predecessors 嘛。那这个明明没有Predecessors 却返回 <span class="hljs-literal"><span class="hljs-literal">true</span></span> ；
不是错了吗 是我理解错误吗
</code></pre></p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/4.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/4.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                zhu
                <span class="pull-right">2018-09-03 21:24</span></h5> <p><pre><code class="hljs coffeescript">博主还没来得及看，我自己想出来了，是我太菜了--，只要 head!=tail 就说明有新的节点进来到队列的尾部了，如果 h.next == <span class="hljs-literal"><span class="hljs-literal">null</span></span>, 说明正在初始化节点中，如果不是初始化中的话，只要 Head 的下一个节点不是 刚进来的 thread 的 的Node,如果是的话就说明没有正在等待的节点，
对了先补充下这个方法的意思，查询是否有任何线程等待获取比当前线程更长的时间。 
<span class="hljs-literal"><span class="hljs-literal">true</span></span>如果有排队线前面的当前线程，并 <span class="hljs-literal"><span class="hljs-literal">false</span></span>如果当前线程在队列或队列的头部是空的 
十分感谢博主的文章，对我的帮助非常大。
</code></pre></p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div></div></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/4.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/4.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                zhu
                <span class="pull-right">2018-09-03 22:18</span></h5> <p><p>博主对于 cancelAcquire() 的 unparkSuccessor(node); 会不会唤醒两次呢。 如果 pred == head；然后又刚好 pred 线程也要出同步块了 也调用了  unparkSuccessor(node);  那这个时候 node.next 是不是 会两次 unpark() 呢，因为 unpark 会抵消 park() ，所以 在第一次 unpark 将线程唤醒了，第二次 unpark 将许可证置为可用的.那么下次 condition 的 waiter 会不会 被抵消掉呢</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                HongJie
                <span class="pull-right">2018-09-03 22:35</span></h5> <p><p>非常抱歉，前面的疑惑没有及时给你回复，我最近有些忙，文章也已经很久没有更新了。</p>
<p>你的问题挺有趣的，我没有仔细去推演每一步，不过我觉得其实这也不是什么大问题。仔细想想，即使真的是两次 unpark 了（假设真的如此），大不了就是后面会出现一次 park 直接返回。</p>
<p>对于 park 方法，我们本来就是要假设它有可能会无故返回的，被中断或者系统的假唤醒，所以这些代码往往都在循环体中。</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div></div></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/4.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/4.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                zhu
                <span class="pull-right">2018-09-04 15:36</span></h5> <p><p>博主您好，对于</p>
<pre><code class="lang-java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setHeadAndPropagate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Node node, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> propagate)</span></span></span><span class="hljs-function"> </span></span>{
        Node h = head;
        setHead(node);
<span class="hljs-comment"><span class="hljs-comment">// head 不是一定不为 null 的吗，因为到了这里，前面的 addWriter() 一定已经入队过了。Head 也肯定初始化过了</span></span>
<span class="hljs-comment"><span class="hljs-comment">// 为什么 判断一遍 h == null 不够 还要判断两边，觉得没有必要判断呀</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (propagate &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> || h == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> || h.waitStatus &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> ||
            (h = head) == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> || h.waitStatus &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) {
            Node s = node.next;
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (s == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> || s.isShared())
                doReleaseShared();
        }
</code></pre>
<p>求博主帮菜鸟解惑下  ☺</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                HongJie
                <span class="pull-right">2018-09-04 15:59</span></h5> <p><p>我翻了一下，没找到 ?应该是我们哪里漏掉了，你找到记得告诉我哈</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div></div></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/4.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/4.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                zhu
                <span class="pull-right">2018-09-04 16:01</span></h5> <p><p>好吧 十分感谢博主</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/20.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/20.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                ykge
                <span class="pull-right">2018-09-08 00:46</span></h5> <p><p>博主 ：请教个问题 
private Node enq(final Node node) {
    for (;;) {
        Node t = tail;
        if (t == null) {
            if (compareAndSetHead(new Node()))
                tail = head;
        } else {
            node.prev = t;
            if (compareAndSetTail(t, node)) {
                // 看这里
                t.next = node;
                return t;
            }
        }
    }
}
看这段代码 ，tail应该指向的还是head节点 ，但是示例图解析  tail怎么到阻塞队列中了？ 而且每插入一个节点 ，tail就跟着后移。很疑惑 ，请博主指点下，谢谢。</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/12.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/12.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                琴弦子
                <span class="pull-right">2018-09-10 16:55</span></h5> <p><p>获取锁、释放锁，阻塞队列的Node数量不会减少吗？好像没看到在哪里减少阻塞队列里面Node的数量？</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/0.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                HongJie
                <span class="pull-right">2018-09-10 18:04</span></h5> <p><p>因为我们通常并不关心阻塞队列中到底有多少 Node</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div></div></div></div><div class="media"><div class="media-left"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/17.png" alt="" class="media-object img-circle" style="width: 50px; height: 50px;"></div> <div class="media-body"><h5 data-toc-skip="" class="media-heading"><img src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/17.png" alt="" class="img-circle" style="display: none; width: 30px; height: 30px;">
                jayzc
                <span class="pull-right">2018-09-29 23:20</span></h5> <p><p>为什么博主的评论全不见了</p>
</p> <p><a href="javascript:;" class="reply">回复</a> <!----></p> <div class="add-comment nested-comment" style="display: none;"><form class="form-horizontal"><div class="form-group"><div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Name <span class="text-theme">*</span></label> <input type="text" placeholder="Name *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label visible-xs">Email <span class="text-theme">*</span></label> <input type="email" placeholder="Email *" class="form-control"></div> <div class="col-md-4 col-sm-12 col-xs-12"><label class="control-label  visible-xs">Website </label> <input type="text" placeholder="Website" class="form-control"></div></div> <div class="form-group"><div class="col-md-12 col-sm-12 col-xs-12 comment-textarea"><textarea rows="6" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea> <div class="comment-bottom"><p class="hidden-xs"><span class="emoji">😂</span> <span class="emoji">😫</span> <span class="emoji">😭</span> <span class="emoji">🤣</span> <span class="emoji">😅</span> <span class="emoji">😣</span> <span class="emoji">😍</span> <span class="emoji">🤗</span></p> <span class="submit">提交</span></div></div></div></form></div> <!----></div></div></div>

<div id="vNewComment" class="add-comment"><h4 data-toc-skip="" style="color: rgb(86, 148, 202);">留下你的评论呗</h4> <form class="form-horizontal"><div class="form-group"><div class="col-md-4"><label class="control-label">Name <span class="text-theme">*</span></label> <input type="text" required="required" class="form-control"></div> <div class="col-md-4"><label class="control-label">Email <span class="text-theme">*</span>（仅用于回复通知）</label> <input type="email" required="required" class="form-control"></div> <div class="col-md-4"><label class="control-label">Website</label> <input type="url" class="form-control"></div></div> <div class="form-group"><div class="col-md-12"><label class="control-label">Comment <span class="text-theme">*</span></label> <textarea rows="6" required="required" placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符" class="form-control" style="overflow-y:hidden;"></textarea></div></div> <div class="form-group"><div class="col-md-12"><button type="submit" class="btn btn-theme">Post Comment</button></div></div></form></div>

<script type="text/x-template" id="comment-template">
    <div class="media">
        <div class="media-left" v-show="model.depth < 4">
            <img class="media-object img-circle" style="width: 50px; height: 50px;"
                 v-bind:src="'https://www.javadoop.com/blogimages/headimgs/' + (model.head) + '.png'" alt="">
        </div>
        <div class="media-body">
            <h5 data-toc-skip class="media-heading">
                <img v-show="model.depth > 3" class="img-circle" style="display: inline; width: 30px; height: 30px;"
                     v-bind:src="'https://www.javadoop.com/blogimages/headimgs/' + (model.head) + '.png'" alt=""/>
                {{model.username}}
                <span class="pull-right">{{model.createTime | formatDate}}</span>
            </h5>
            <p v-html="model.content"></p>
            <p>
                <a href="javascript:;" class="reply" @click="toggleCommentArea" v-if="!this.showCommentArea">回复</a>
                <a href="javascript:;" class="reply" @click="toggleCommentArea" v-if="this.showCommentArea">取消</a>
            </p>

            <div class="add-comment nested-comment" v-show='showCommentArea'>
                <form class="form-horizontal">
                    <div class="form-group">
                        <div class="col-md-4 col-sm-12 col-xs-12">
                            <label class="control-label visible-xs">Name <span class="text-theme">*</span></label>
                            <input type="text" class="form-control" placeholder="Name *"
                                   v-model='currentuser.username'>
                        </div>
                        <div class="col-md-4 col-sm-12 col-xs-12">
                            <label class="control-label visible-xs">Email <span class="text-theme">*</span></label>
                            <input type="email" class="form-control" placeholder="Email *"
                                   v-model='currentuser.email'>
                        </div>
                        <div class="col-md-4 col-sm-12 col-xs-12">
                            <label class="control-label  visible-xs">Website </label>
                            <input type="text" class="form-control" placeholder="Website" v-model='currentuser.website'>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-md-12 col-sm-12 col-xs-12 comment-textarea">
                            <textarea class="form-control" rows="6" v-model='commentText' placeholder="请使用MarkDown语法编辑，换行请空一行，请不要超过1024个字符"></textarea>
                            
                                
                                    
                                    
                                    
                                    
                                    
                                    
                                    
                                    
                                    
                                    
                                    
                                
                                
                            
                            <div class="comment-bottom">
                                <p class="hidden-xs">
                                    <span class="emoji" @click="insertEmoji('😂')">😂</span>
                                    <span class="emoji" @click="insertEmoji('😫')">😫</span>
                                    <span class="emoji" @click="insertEmoji('😭')">😭</span>
                                    <span class="emoji" @click="insertEmoji('🤣')">🤣</span>
                                    <span class="emoji" @click="insertEmoji('😅')">😅</span>
                                    <span class="emoji" @click="insertEmoji('😣')">😣</span>
                                    <span class="emoji" @click="insertEmoji('😍')">😍</span>
                                    <span class="emoji" @click="insertEmoji('🤗')">🤗</span>
                                </p>
                                
                                <span class="submit" @click="submit">提交</span>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div v-if='hasChildren'>
                <comment v-for="(model, index) in model.children" :model='model' :idx="index"
                         :size="model.children.length" :currentuser="currentuser"></comment>
            </div>

        </div>
    </div>
</script>
<script>

    Vue.filter('formatDate', function (value) {
        if (value) {
            var delta = (new Date().getTime() - value) / 1000;
            if (delta < 60) {
                return "刚刚";
            } else if (delta / 60 < 60) {
                return (parseInt(delta / 60)) + " 分钟前";
            } else if (delta / 3600 < 24) {
                return (parseInt(delta / 3600)) + " 小时前";
            } else {
                var date = new Date(value);
                return date.getFullYear() + "-" + (addZero(date.getMonth() + 1)) + "-" + addZero(date.getDate()) + " " + addZero(date.getHours()) + ":" + addZero(date.getMinutes());
            }
        }
    });

    Vue.component("comment", {
        template: '#comment-template',
        props: ["model", "idx", "size", "currentuser"],
        data: function () {
            return {
                showCommentArea: false,
                commentText: ""
            }
        },
        computed: {
            hasChildren: function () {
                return this.model.children && this.model.children.length;
            }
        },
        methods: {
            toggle: function () {
                if (this.hasChildren) {
                    this.model.open = !this.model.open;
                }
            },
            toggleCommentArea: function () {
                this.showCommentArea = !this.showCommentArea;
            },
            insertEmoji: function (emoji) {
                var $text = $(event.target).parents('.comment-bottom').prev('textarea');
                var cursorPos = $text.prop('selectionStart');
                var v = $text.val();

                var textBefore = v.substring(0, cursorPos);
                var textAfter = v.substring(cursorPos, v.length);

                this.commentText = textBefore + emoji + textAfter;
            },
            submit: function () {
                var _this = this;

                var parentId = _this.model.id;

                if (_this.commentText.length > 1024) {
                    alert("要不评论内容写少一点？");
                    return false;
                }
                ajaxRequest("POST", "/comment/createComment", {
                    postId: 1,
                    parentId: parentId,
                    content: _this.commentText,
                    username: _this.currentuser.username,
                    email: _this.currentuser.email,
                    website: _this.currentuser.website
                }, function (comment) {
//                    showSuccessNotify("评论成功");
                    _this.showCommentArea = false;
                    _this.model.children.unshift(comment);
                    _this.commentText = "";
                    $.cookie("username", _this.currentuser.username, {expires: 1000, path: '/'});
                    $.cookie("email", _this.currentuser.email, {expires: 1000, path: '/'});
                    $.cookie("website", _this.currentuser.website, {expires: 1000, path: '/'});
                    setTimeout(function () {
                        $('.comments-block pre code').each(function (i, block) {
                            hljs.highlightBlock(block);
                        });
                    }, 200)
                });
            }
        },
        updated: function () {
            // 性能不行
//            $('pre code').each(function (i, block) {
//                hljs.highlightBlock(block);
//            });
        }
    });
    var Vcomment = new Vue({
        el: '#vcomments',
        data: {
            commentsdata: [],
            currentuser: {}
        },
        updated: function () {
//            showSuccessNotify("updated")
            $('pre code').each(function (i, block) {
                hljs.highlightBlock(block);
            });
        }
    });

    var VnewComment = new Vue({
        el: '#vNewComment',
        data: {
            commentText: "",
            username: "",
            email: "",
            website: ""
        },
        methods: {
            submit: function () {
                var _this = this;

                if (_this.commentText.length > 1024) {
                    alert("要不评论内容写少一点？");
                    return false;
                }
                if (_this.username.length == 0) {
                    alert("请输入 name，便于评论显示");
                    return false;
                }
                if (_this.email.length == 0) {
                    alert("请输入 email，便于可能的联系");
                    return false;
                }
                ajaxRequest("POST", "/comment/createComment", {
                    postId: 1,
                    content: _this.commentText,
                    username: _this.username,
                    email: _this.email,
                    website: _this.website
                }, function (comment) {
                    alert("评论成功");
                    Vcomment.commentsdata.push({
                        createTime: comment.createTime,
                        content: comment.content,
                        head: comment.head,
                        depth: comment.depth,
                        username: comment.username,
                        children: []
                    });
                    Vcomment.currentuser.username = _this.username;
                    Vcomment.currentuser.email = _this.email;
                    Vcomment.currentuser.website = _this.website;

                    _this.commentText = "";
                    $.cookie("username", _this.username, {expires: 1000, path: '/'});
                    $.cookie("email", _this.email, {expires: 1000, path: '/'});
                    $.cookie("website", _this.website, {expires: 1000, path: '/'});
                    setTimeout(function () {
                        $('.comments-block pre code').each(function (i, block) {
                            hljs.highlightBlock(block);
                        });
                    }, 200)
                });
            }
        }
    });


    ajaxRequest("GET", "/comment/listComment", {postId: 1}, function (data) {
        Vcomment.commentsdata = data.comments;
    });
    ajaxRequest("GET", "/user/getUserInfo", {}, function (data) {
        if (data != null) {
            Vcomment.currentuser = data;

            VnewComment.username = data.username;
            VnewComment.email = data.email;
            VnewComment.website = data.website;
        } else {
            Vcomment.currentuser.username = $.cookie("username");
            Vcomment.currentuser.email = $.cookie("email");
            Vcomment.currentuser.website = $.cookie("website");

            VnewComment.username = $.cookie("username");
            VnewComment.email = $.cookie("email");
            VnewComment.website = $.cookie("website");
        }
    });



    function ajaxRequest(reqtype, actionUrl, actionData, callback, asy) {
        $.ajax({
            type: reqtype || "GET",
            url: actionUrl,
            cache: false,
            data: actionData,
            async: asy || false,
            success: function (response) {
                if (response.result) {
                    callback(response.data);
                } else {
                    alert(response.message);
                }
            },
            error: function (result) {
                console.log(result)
            },
            complete: function (xhr) {
                if (xhr.status == 401) {
                    alert("请登录后再操作")
                    // Vlogin.showModal = true;
                } else if (xhr.sta == 404) {
                    alert("请求地址错误");
                }
            }
        });
    }
    function addZero(v) {
        if (v < 10) {
            return '0' + v;
        } else {
            return v + "";
        }
    }
</script>
            </div>

            <hr class="hidden-xs">
            <p class="pull-right hidden-xs">Copyright © 2018 JavaDoop 联系我: hongjie.v#gmail.com</p>

        </div>
    </div>
    <a href="javascript:;" id="settings" title="settings" class="show" onclick="toggleSettings()">
        <i class="glyphicon glyphicon-cog"></i>
    </a>
    <a href="https://javadoop.com/post/AbstractQueuedSynchronizer#" id="back-to-top" title="Back to top" class="">
        <i class="glyphicon glyphicon-chevron-up"></i>
    </a>
</div>
<div id="settings-panel" style="display: none;"><div class="line"><button style="width: 50%;">待开发</button> <button style="width: 50%;">显示导航</button></div> <div class="line"><button style="width: 50%; font-size: 14px;">A</button> <button style="width: 50%; font-size: 16px;">A</button></div> <div class="line"><button style="width: 50%;">PingFang</button> <button style="width: 50%;">Helvetica</button></div> <div class="line" style="border-bottom: 0px;"><button style="width: 33%;">Night</button> <button style="width: 33%;">Cat</button> <button style="width: 33%;">Light</button></div></div>

<script src="./一行一行源码分析清楚AbstractQueuedSynchronizer_files/javadoop-toc-spy.js"></script>
<script>
    $(function () {


        $('pre code').each(function (i, block) {
            hljs.highlightBlock(block);
        });

        $('.comment-textarea textarea').each(function () {
            this.setAttribute('style', 'overflow-y:hidden;');
        }).on('input', function () {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight + 40) + 'px';
        });

        $("#vNewComment textarea").each(function () {
            this.setAttribute('style', 'overflow-y:hidden;');
        }).on("input", function () {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        if ($('#back-to-top').length) {
            var scrollTrigger = 800,
                backToTop = function () {
                    var scrollTop = $(window).scrollTop();
                    if (scrollTop > scrollTrigger) {
                        $('#back-to-top').addClass('show');
                    } else {
                        $('#back-to-top').removeClass('show');
                    }
                };
            backToTop();
            $(window).on('scroll', function () {
                backToTop();
            });
            $('#back-to-top').on('click', function (e) {
                e.preventDefault();
                $('html,body').animate({
                    scrollTop: 0
                }, 700);
            });
        }
        $("body").on('click', function (event) {
            if (!$(event.target).closest('#settings-panel').length && !$(event.target).closest('#settings').length) {
                vSettings.$data.showSettings = false;
            }
        });
    });

    function toggleSettings() {
        vSettings.$data.showSettings = !vSettings.$data.showSettings;
    }

    var vSettings = new Vue({
        el: "#settings-panel",
        data: {
            fontSize: 14,
            fontFamily: 'Helvetica',
            theme: 'white',
            showSettings: false,
            toggleTocText: "显示导航"
        },
        created: function () {
            var cachedTheme = $.cookie("theme-2051");
            if (cachedTheme) {
                this.theme = cachedTheme;
                $("body").attr("class", cachedTheme);
            }

            this.fontSize = parseInt($("body").css("font-size"));
            var cachedFontSize = $.cookie("fontSize");
            if (cachedFontSize) {
                this.fontSize = cachedFontSize;
                $("body").css("font-size", cachedFontSize + "px");
            }

            var cachedFamily = $.cookie("fontFamily");
            if (cachedFamily) {
                this.fontFamily = cachedFamily;
                if (cachedFamily == 'Helvetica') {
                    var val = '"Helvetica Neue", "Hiragino Sans GB", "Microsoft YaHei", Arial, sans-serif';
                    $("body").css("font-family", val);
                } else {
                    var val = "PingFang SC,-apple-system,BlinkMacSystemFont,Helvetica Neue,Microsoft YaHei,Source Han Sans SC,Noto Sans CJK SC,WenQuanYi Micro Hei,sans-serif";
                    $("body").css("font-family", val);
                }
            }
        },
        watch: {
            fontSize: function (fontSize) {
                if (fontSize > 20) {
                    this.fontSize = 20;
                }
                if (fontSize < 10) {
                    this.fontSize = 10;
                }
                $.cookie("fontSize", this.fontSize);
                $("body").css("font-size", this.fontSize + "px");
            },
            fontFamily: function (f) {
                if (f == 'Helvetica') {
                    var val = '"Helvetica Neue", "Hiragino Sans GB", "Microsoft YaHei", Arial, sans-serif';
                    $("body").css("font-family", val);
                } else {
                    var val = "PingFang SC,-apple-system,BlinkMacSystemFont,Helvetica Neue,Microsoft YaHei,Source Han Sans SC,Noto Sans CJK SC,WenQuanYi Micro Hei,sans-serif";
                    $("body").css("font-family", val);
                }
                $.cookie("fontFamily", f);
            },
            theme: function (t) {
                $.cookie("theme-2051", t);
                $("body").attr("class", t);
            }
        },
        methods: {
            toggleToc: function () {
                console.log("toggle toc")
                var marginLeft = $("body").css("margin-left");
                if (parseInt(marginLeft)) {
                    // 当前有toc,去掉toc
                    $("body").css("margin-left", "0");
                    $("#content").removeClass("showToc");
                    $("#toc").hide(700);
                    this.toggleTocText = "显示导航";
                } else {
                    $("body").css("margin-left", "300px");
                    $("#content").addClass("showToc");
                    $("#toc").show(700);
                    $('body').scrollspy("refresh");
                    this.toggleTocText = "隐藏导航";
                }
            }
        }
    })

</script>
<script>
    //    var _hmt = _hmt || [];
    //    (function () {
    //        var hm = document.createElement("script");
    //        hm.src = "https://hm.baidu.com/hm.js?edf6136c3e6c4fc0960cbbe3ebdd9cc4";
    //        var s = document.getElementsByTagName("script")[0];
    //        s.parentNode.insertBefore(hm, s);
    //    })();
    window.console && window.console.log && console.log("以此主题怀念那些过去的岁月~~~");
</script>


</body></html>